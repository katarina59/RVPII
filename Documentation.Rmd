---
title: "Analysis of Police Incidents in the City of Seattle"
author: "Katarina Medic"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = "center")
```

### Dataset on Police Incidents in the City of Seattle

The dataset on police incidents in the City of Seattle includes a collection of events related to 911 emergency calls recorded from 2010 to the present day. The dataset contains approximately 6 million records and has a total size of 5.6GB. It is an open dataset obtained from the official website of the City of Seattle and is available at the following
[link](https://data.seattle.gov/Public-Safety/Call-Data/33kz-ixgy/about_data).

This dataset contains information about calls made to the police and the corresponding police responses in Seattle. The columns in the dataset are as follows:

1.  **CAD Event Number** – Unique event identification number.
2.  **Event Clearance Description** – How the police resolved the event.
3.  **Call Type** – Type of call with 10 different values (911, Alarm, Onview, etc.)
4.  **Priority** – Call priority with values ranging from 1 (lowest priority) to 9 (highest priority).
5.  **Initial Call Type** – Initial classification of the call by the 911 call center operator, with 325 different values.
6.  **Final Call Type** – Final classification of the call by the police officer after review, with 431 different values.
7.  **Original Time Queued** – Time when the call was recorded.
8.  **Arrived Time** – Time when the police arrived at the scene.
9.  **Precinct** – Police station in Seattle.
10. **Sector** – Police sector.
11. **Beat** – The area and time during which a police officer is on patrol.
12. **Blurred_Longitude** – Geographic longitude of the event.
13. **Blurred_Latitude** – Geographic latitude of the event.

The dataset provides detailed information on all calls received by the police, including call types, priorities, call and response times, as well as the geographic locations of the incidents. It also includes the initial and final classification of each call, enabling analysis of how incidents are categorized and resolved.

# Initial Data Preparation

## Loading and Preparing the Necessary Libraries

```{r eval=T, results='hide', include=FALSE}
library(dplyr)
library(ggplot2)
library(knitr)
library(ggmap)
library(sparklyr)


#spark_install(version = "3.5")
conf <- spark_config()
conf$`sparklyr.shell.driver-memory` <- "16G"
conf$spark.memory.fraction <- 0.9

sc <- spark_connect(master = "local", 
                    version = "3.5",
                    config = conf)
```

## Data Loading

-   Given the size of the dataset (5.6 GB), the data is loaded and further transformed using Apache Spark tools.

-   To ensure the correct data types are used, a schema is specified according to which Spark loads the data frames.

```{r eval = T, results = 'hold'}
schema <- list(
  CAD_Event_Number = "character",
  Event_Clearance_Description = "character",
  Call_Type = "character",
  Priority = "character",
  Initial_Call_Type = "character",
  Final_Call_Type = "character",
  Original_Time_Queued = "character",
  Arrived_Time = "character",
  Precinct = "character",
  Sector = "character",
  Beat = "character",
  Blurred_Longitude = "numeric",
  Blurred_Latitude = "numeric"
)

df <- spark_read_csv(sc, name = "police_calls", path = "Call_Data.csv", header = TRUE, columns = schema)

df %>% 
  select(Original_Time_Queued, Arrived_Time) %>% 
  head(20) %>% 
  collect() %>%
  print()
```

## Data Preparation for Analysis

-   In order to perform a proper data analysis, it is necessary to carry out several transformations on the initial dataset:
  
### Removing All Missing Values from the Dataset

```{r eval=T, results='hold'}
df_clean <- df %>% na.omit()
```

### Converting Data to the Appropriate Format

```{r eval = T, results='hold'}
df_clean <- df_clean %>%
  mutate(
    Original_Time_Queued = to_timestamp(Original_Time_Queued, "MM/dd/yyyy hh:mm:ss a"),
    Arrived_Time = to_timestamp(Arrived_Time, "yyyy MMM dd hh:mm:ss a")
  )

```

### Filtering Cases Where the Police Arrival Time Precedes the Incident Time

-   This is an impossible case

```{r}
df_clean <- df_clean %>%
  filter(!is.na(Original_Time_Queued) & !is.na(Arrived_Time) & Original_Time_Queued < Arrived_Time)
```

# Visualization of the Distribution of Individual Features and Relationships Between Features

### Displaying Statistical Information on Incident Times

```{r}
df_clean %>% summarise(
  min_original_time = min(Original_Time_Queued, na.rm = TRUE),
  max_original_time = max(Original_Time_Queued, na.rm = TRUE),
  min_arrived_time = min(Arrived_Time, na.rm = TRUE),
  max_arrived_time = max(Arrived_Time, na.rm = TRUE)
) %>% collect()
```

### Visualization of the Distribution by Police Precincts:

```{r}
precinct_counts <- df_clean %>%
  group_by(Precinct) %>%
  summarise(Count = n())

ggplot(precinct_counts, aes(x = Precinct, y = Count, fill = Precinct)) +
  geom_bar(stat = "identity") +
  labs(title = "Prikaz raspodele po policijskim upravama",
       x = "Policijska uprava",
       y = "Broj pojava",
       fill = "Precinct")
```